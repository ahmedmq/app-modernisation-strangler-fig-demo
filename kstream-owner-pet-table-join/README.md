# kstream-owner-pet-table-join
<hr/>

The diagram below shows an overview of the streaming piepline

![Flow](docs/flow.png)

This application will read events from the owner topic (`mysql.petclinic.owners`) and the pet topic (`mysql.petclinic.pets`) and process them in a streaming pipeline:

- The events from the two topics are joined on Owner ID
- Each owner is enriched with its pets data
- The aggregated data is written out to a third topic `mongo.petclinic.owner.pets`

The below table summarizes the `owners` and `pets` event generated by Debezium and the nested structure generated by the KStream pipeline

| Owner Event                                                                                                                                                                                                     | Pet Event                                                                                                                                       | Owner with Pet Event                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <pre>{<br>&nbsp;"id": 1,<br>&nbsp;"first_name": "George",<br>&nbsp;"last_name": "Franklin",<br>&nbsp;"address": "110 W. Liberty St.",<br>&nbsp;"city": "Madison",<br>&nbsp;"telephone": "6085551023"<br>}</pre> | <pre> {<br>&nbsp;"id": 1,<br>&nbsp;"name": "Leo",<br>&nbsp;"birth_date": 11207,<br>&nbsp;"type_id": 1,<br>&nbsp;"owner_id": 1<br>&nbsp;} </pre> | <pre> {<br>&nbsp;"owner": {<br>&nbsp;&nbsp;"id": 1,<br>&nbsp;&nbsp;"first_name": "George",<br>&nbsp;&nbsp;"last_name": "Franklin",<br>&nbsp;&nbsp;"address": "110 W. Liberty St.",<br>&nbsp;&nbsp;"city": "Madison",<br>&nbsp;&nbsp;"telephone": "6085551023"<br>&nbsp;},<br>&nbsp;"pets": [<br>&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;"id": 1,<br>&nbsp;&nbsp;&nbsp;"name": "Leo",<br>&nbsp;&nbsp;&nbsp;"birth_date": "11207",<br>&nbsp;&nbsp;&nbsp;"type_id": 1,<br>&nbsp;&nbsp;&nbsp;"owner_id": 1<br>&nbsp;&nbsp;}<br>&nbsp;]<br>}</pre> |


The application is developed using Spring Boot 3.0 and [Spring Cloud Stream Kafka streams binder](https://docs.spring.io/spring-cloud-stream-binder-kafka/docs/current/reference/html/spring-cloud-stream-binder-kafka.html#_kafka_streams_binder)

## Building and Running the application

### Prerequisites
The following should be installed in your system:

* [Docker](https://docs.docker.com/engine/install/)
* [Docker Compose](https://docs.docker.com/compose/install/)

### Running kstream-owner-pet-table-join application

- From a new terminal window inside the `kstream-owner-pet-table-join` folder, run the following command:

    ```bash
    docker compose up -d
    ```
  This will start Zookeeper, Kafka and Kafka UI containers.


- Run the following command to start the `kstream-owner-pet-table-join` application
    ```bash
    ./mvnw spring-boot:run
    ```
  
- Run the `GenerateOwnerAndPet` java code to produce test `owner` and `pet` events into `mysql.petclinic.owners` and `mysql.petclinic.pets` topics respectively.


- Access the Kafka UI [topic](http://localhost:8087/ui/clusters/local/all-topics/mongo.petclinic.owner.pets/messages?keySerde=String&valueSerde=String&limit=100) to see the events generated in `mongo.petclinic.owner.pets`

![Topic](docs/topic.png)
